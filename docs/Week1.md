# Week 1 実施手順（コード例なし）

目的: モノレポ初期化、型生成パイプライン整備、住所入力・バリデーションのTDD（Red→Green）、距離キャッシュ設計、E2E の初動を一気通貫で完了する。

参照: docs/Design.md:232 のロードマップ項目に準拠。

---

## 0) ゴールと成果物（Definition of Done）

- モノレポの最小構成が起動し、型チェック・単体テスト・E2E を一通り実行可能。
- 型生成パイプライン（DB 型、API 契約、環境変数）をワンコマンドで同期可能。
- 住所入力 UI のバリデーションが TDD で Red→Green 完了（空行/2件未満/重複の取り扱いが明確）。
- 距離キャッシュの設計（キー設計・TTL・保存先・RLS/メトリクス方針）が文書化されている。
- E2E（Playwright）で「住所入力→バリデーション表示」の基本シナリオが通る（外部APIはMSWモック）。

---

## 1) 事前準備（環境・アカウント）

- Node.js LTS / pnpm / Python 3.11 の準備。
- アカウント/キーの準備（運用接続は Week 1 では不要、MSW モックで代替）
  - Mapbox トークン、Google Maps API キー、Supabase プロジェクト（DB）。
- 環境変数テンプレート（.env.example）を作成し、必須項目を列挙。

---

## 2) モノレポ初期化（pnpm + Turborepo）

作業観点: 「最小で動く」「型チェック/テスト/E2E が回る」ことを優先。過剰な設定は避ける。

- ルートにモノレポを作成し、ワークスペースを定義（apps/*, packages/*）。
- ルート設定ファイルの雛形を用意（tsconfig.base、lint/format 設定、turbo 設定）。
- ディレクトリの初期化
  - apps/web: Next.js アプリ（App Router）。
  - packages/api: tRPC ルータと契約（Zod参照）を置く場所。
  - packages/validators: フォーム/ドメインの Zod スキーマ群。
  - packages/supabase: DB クライアント初期化、型（後述の生成物）置き場。
  - packages/config: 共有定数、環境変数バリデーション（Zod）置き場。
- ルートスクリプト（目安）
  - install、build、dev、typecheck、lint、test、e2e、generate（型生成）を整備。
- 最小起動確認
  - apps/web の開発サーバが起動すること。
  - typecheck／test が空実装でも成功すること。

---

## 3) 型生成パイプラインの整備

目的: DB 型・API 契約・環境変数を一貫した単一コマンドで同期。

- DB 型（Supabase）
  - Supabase の型生成コマンドを packages/supabase に出力するスクリプトを用意。
  - 生成物をバージョン管理下に置く（再現性のため）。
- API 契約
  - packages/api の tRPC ルータ入出力を Zod で定義し、型から UI/サーバで参照できる状態に。
  - 生成ではなく「単一ソース（Zod）からの型派生」を徹底。
- 環境変数
  - packages/config に Zod で環境変数スキーマを定義し、アプリ起動時に検証。
- Turborepo 統合
  - generate → typecheck → test → build → e2e の順序をパイプライン化（キャッシュ有効化）。

---

## 4) 住所入力・バリデーションを TDD で実装（Red→Green）

受入基準（docs/Design.md 付録と整合）
- 空行のみの入力はエラー表示。
- 一意住所の件数が 2 件未満はエラー。
- 重複行は正規化後に一意化（前後空白・全角半角・改行などの扱いを定義）。
- 正常時はエラーが消え、最適化ボタンが活性化する。

手順
1) Red（失敗するテストの先行）
   - packages/validators に住所リスト用スキーマのテストを作成（正常系/空行/2件未満/重複/トリム）。
   - apps/web にフォームの UI テスト（Testing Library）を用意：入力→エラー表示の確認。
2) Green（最小実装）
   - Zod スキーマ実装で各ケースを満たす最小限のロジックを追加。
   - UI はテキストエリア＋ボタン＋エラー表示のみ（スタイル最小）。
3) Refactor（読みやすさ・再利用）
   - 正規化関数を utilities に抽出。
   - エラーメッセージ文言を i18n しやすい形に整理。

完了の確認
- 単体/統合テストがグリーン。
- UI 手動確認で受入基準どおり動作。

---

## 5) 距離キャッシュの設計（実装前の合意）

目的: Google Distance Matrix の呼び出しを削減し、応答時間とコストを最適化。Week 1 は設計と文書化に留める。

設計観点
- キー設計: 正規化済みの出発地/目的地（座標）、移動モード、時間帯バケット（例: 分単位の丸め）を含めハッシュ化。
- 値: 距離[m]、所要時間[s]、プロバイダ、取得時刻、失効（expiresAt/TTL）、リクエストパラメータの要約。
- 保存先: Supabase/PostgreSQL（テーブル例: distance_cache）、主キーはハッシュ、インデックスは expiresAt。
- TTL: 7〜30 日（まず 14 日で開始）、期限切れはバックグラウンド再取得で更新。
- 取得ポリシー: キャッシュヒット → 即返却、ミス → Google 呼び出し → 保存。
- フォールバック: 失敗時は指数バックオフ・一時的エラーを区別し UI に通知。
- RLS/権限: サーバ側のみ読み書き可能（匿名クライアントからの直アクセス禁止）。
- 観測性: キャッシュヒット率、ミス率、API 呼び出し数、p95 応答時間のメトリクスを収集。

成果物
- docs/ADR/ 距離キャッシュ設計ドキュメント（キー、TTL、スキーマ、RLS、観測性、失敗時動作）を作成。
- packages/api にキャッシュ I/F の契約（get/put）をコメント付きで記述（実装は着手しない）。

---

## 6) E2E 初動（Playwright + MSW）

目的: 「住所入力→バリデーション表示」の基本シナリオを自動化し、以降の機能追加の安全網にする。

手順
- Playwright を apps/web に導入し、ローカル開発サーバに接続する設定を用意。
- MSW を導入し、外部 API（Google/Optimizer/Supabase ネットワーク）をテスト時にモック。
- シナリオ: ペーストした住所から空行を含むケースでエラー表示 → 正しい 2 件を入力でエラー解消 → ボタン活性化まで。
- a11y の自動チェックを 1 つ加える（ラベル関連）。

完了の確認
- e2e スクリプトでテストが成功し、レポートが出力されること。

---

## 7) 1 週間の進行目安（タイムボックス）

- Day 1: モノレポ初期化（起動/型/テストの骨格まで）。
- Day 2: 型生成パイプライン（generate/typecheck/test の連結）。
- Day 3: 住所バリデーション Red（テスト作成）→ Green（最小実装）。
- Day 4: 距離キャッシュ設計の文書化・合意、UI リファクタ。
- Day 5: E2E 初動、全体通し（typecheck/test/e2e）と不具合潰し、ドキュメント整備。

---

## 8) チェックリスト（提出・確認用）

- [ ] apps/web が起動し、フォームが表示される。
- [ ] typecheck/test/e2e がローカルで通る。
- [ ] generate（型生成）で DB 型が更新され、ビルドが型崩れせず成功する。
- [ ] 住所バリデーションの受入基準を満たす（手動/E2E）。
- [ ] 距離キャッシュの ADR がレビュー合意済み。
- [ ] docs/ に Week 1 の実績と次週課題メモを追記。

---

## 9) リスクと回避策（Week 1 時点）

- 外部 API キー未確定 → MSW で全モック、E2E/単体はローカル完結で担保。
- 型生成の不安定さ → 生成物をコミットし、CI で差分監視。失敗時は前版を使用。
- UI 過剰実装 → 受入基準を満たす最小要素（テキストエリア・ボタン・エラー）に限定。
